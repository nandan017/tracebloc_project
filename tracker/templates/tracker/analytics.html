{% extends "tracker/base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
{{ stage_labels|json_script:"stage-labels" }}
{{ stage_data|json_script:"stage-data" }}
{{ avg_time_labels|json_script:"avg-time-labels" }}
{{ avg_time_data|json_script:"avg-time-data" }}

<div class="mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-white">Analytics Dashboard</h1>
    <p class="text-text-muted mt-2">Insights into your supply chain performance.</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-base-100 p-6 rounded-lg border border-base-100/50">
        <p class="text-sm font-medium text-text-muted">Total Products Tracked</p>
        <p class="text-3xl font-extrabold text-white mt-2">{{ total_products }}</p>
    </div>
    <div class="bg-base-100 p-6 rounded-lg border border-base-100/50">
        <p class="text-sm font-medium text-text-muted">Total Updates Logged</p>
        <p class="text-3xl font-extrabold text-white mt-2">{{ total_updates }}</p>
    </div>
    <div class="bg-base-100 p-6 rounded-lg border border-base-100/50">
        <p class="text-sm font-medium text-text-muted">Slowest Stage</p>
        <p class="text-3xl font-extrabold text-white mt-2">{{ slowest_stage_name }}</p>
        <p class="text-sm text-accent">{{ slowest_stage_time }} days on average</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
    <div class="bg-base-100 p-6 rounded-lg shadow-lg lg:col-span-3">
        <h2 class="text-xl font-semibold text-white mb-4">Average Time per Stage (in Days)</h2>
        <canvas id="avgTimeChart"></canvas>
    </div>
    <div class="bg-base-100 p-6 rounded-lg shadow-lg lg:col-span-2">
        <h2 class="text-xl font-semibold text-white mb-4">Activity by Stage</h2>
        <canvas id="stageOverviewChart" class="max-h-80 mx-auto"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Use a more techy color palette
    const chartColors = ['#FF4500', '#FF8C00', '#FFA500', '#FFD700', '#A9A9A9', '#808080'];
    const textColor = '#9CA3AF';
    const gridColor = '#1F1F1F';

    // --- Safely parse data from Django ---
    const stageLabels = JSON.parse(document.getElementById('stage-labels').textContent);
    const stageData = JSON.parse(document.getElementById('stage-data').textContent);
    const avgTimeLabels = JSON.parse(document.getElementById('avg-time-labels').textContent);
    const avgTimeData = JSON.parse(document.getElementById('avg-time-data').textContent);

    // --- Chart 1: Stage Overview (Pie Chart) ---
    const stageCtx = document.getElementById('stageOverviewChart').getContext('2d');
    new Chart(stageCtx, {
        type: 'pie',
        data: {
            labels: stageLabels,
            datasets: [{
                label: 'Number of Updates',
                data: stageData,
                backgroundColor: chartColors,
                borderColor: '#111111',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: textColor, font: { family: 'Inter' } }
                }
            }
        }
    });

    // --- Chart 2: Average Time (Bar Chart) ---
    const avgTimeCtx = document.getElementById('avgTimeChart').getContext('2d');
    new Chart(avgTimeCtx, {
        type: 'bar',
        data: {
            labels: avgTimeLabels,
            datasets: [{
                label: 'Average Days',
                data: avgTimeData,
                backgroundColor: 'rgba(255, 69, 0, 0.6)',
                borderColor: 'rgba(255, 69, 0, 1)',
                borderWidth: 1,
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            scales: {
                x: { ticks: { color: textColor, font: { family: 'Inter' } }, grid: { color: gridColor } },
                y: { ticks: { color: textColor, font: { family: 'Inter' } }, grid: { color: gridColor } }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    bodyFont: { family: 'Inter' },
                    titleFont: { family: 'Inter' }
                }
            }
        }
    });
</script>
{% endblock %}