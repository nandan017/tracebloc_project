{% extends "tracker/base.html" %}

{% block title %}Tracking for {{ product.name }}{% endblock %}

{% block content %}
{{ path_coordinates|json_script:"path-coordinates" }}

<div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-white">{{ product.name }}</h1>
    <p class="text-accent font-mono mt-2">{{ product.sku }}</p>
</div>

<div id="map" class="h-96 w-full rounded-lg bg-base-100 mb-12 border border-base-100/50"></div>

<div class="relative max-w-2xl mx-auto">
    <div class="absolute left-4 top-2 h-full border-l-2 border-base-100"></div>
    {% for step in product.steps.all %}
        {% include 'tracker/partials/_history_item.html' %}
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const pathCoordinates = JSON.parse(document.getElementById('path-coordinates').textContent);

        if (pathCoordinates.length > 0) {
            // Initialize the map and set its view to the first coordinate
            const map = L.map('map').setView(pathCoordinates[0], 13);

            // Add a tile layer from OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add markers for each step
            pathCoordinates.forEach((coord, index) => {
                L.marker(coord).addTo(map)
                    .bindPopup(`Step ${index + 1}`);
            });

            // Draw a line connecting the markers
            if (pathCoordinates.length > 1) {
                const polyline = L.polyline(pathCoordinates, {color: '#FF4500'}).addTo(map);
                // Zoom the map to fit the entire path
                map.fitBounds(polyline.getBounds().pad(0.1));
            }
        } else {
             // If no coordinates, hide the map or show a message
            document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full text-text-muted">No map data available.</div>';
        }
    });
</script>
{% endblock %}